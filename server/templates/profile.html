{% extends "base.html" %}

{% block title %}{{ profile.username or profile.goodreads_id }} - Shelf Aware{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold">{{ profile.username or profile.goodreads_id }}</h1>
    <p class="text-stone-500">{{ profile.book_count }} books analyzed</p>
</div>

<!-- Tabs -->
<div class="border-b border-stone-200 mb-6">
    <nav class="flex gap-1 -mb-px" id="profile-tabs">
        <button class="tab-btn active px-4 py-2 text-sm font-medium border-b-2 border-stone-800 text-stone-800"
                data-tab="overview">Overview</button>
        {% if ai.get('psychological') %}
        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-stone-500 hover:text-stone-700"
                data-tab="psychological">Psych Profile</button>
        {% endif %}
        {% if ai.get('roast') %}
        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-stone-500 hover:text-stone-700"
                data-tab="roast">Roast</button>
        {% endif %}
        {% if ai.get('vibe_check') %}
        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-stone-500 hover:text-stone-700"
                data-tab="vibe_check">Vibe Check</button>
        {% endif %}
        {% if ai.get('red_green_flags') %}
        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-stone-500 hover:text-stone-700"
                data-tab="flags">Flags</button>
        {% endif %}
        {% if ai.get('blind_spots') %}
        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-stone-500 hover:text-stone-700"
                data-tab="blind_spots">Blind Spots</button>
        {% endif %}
        {% if ai.get('reading_evolution') %}
        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-stone-500 hover:text-stone-700"
                data-tab="evolution">Evolution</button>
        {% endif %}
        {% if ai.get('recommendations') %}
        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-stone-500 hover:text-stone-700"
                data-tab="recommendations">Recs</button>
        {% endif %}
    </nav>
</div>

<!-- Overview Tab -->
<div class="tab-panel" id="panel-overview">
    <!-- Key Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-4 text-center">
            <p class="text-2xl font-bold">{{ profile.book_count }}</p>
            <p class="text-stone-500 text-sm">Books Read</p>
        </div>
        {% if stats.get('hater_hype') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-4 text-center">
            <p class="text-2xl font-bold">{{ stats.hater_hype.label }}</p>
            <p class="text-stone-500 text-sm">Rating Style</p>
        </div>
        {% endif %}
        {% if stats.get('attention_span') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-4 text-center">
            <p class="text-2xl font-bold">{{ stats.attention_span.label }}</p>
            <p class="text-stone-500 text-sm">Avg {{ stats.attention_span.avg_pages|int }} pages</p>
        </div>
        {% endif %}
        {% if stats.get('genre_radar') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-4 text-center">
            <p class="text-2xl font-bold">{{ stats.genre_radar.top_genre }}</p>
            <p class="text-stone-500 text-sm">Top Genre</p>
        </div>
        {% endif %}
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% if stats.get('rating_distribution') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Rating Distribution</h3>
            <canvas id="chart-ratings" height="200"></canvas>
        </div>
        {% endif %}

        {% if stats.get('genre_radar') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Genre Radar</h3>
            <canvas id="chart-genres" height="200"></canvas>
        </div>
        {% endif %}

        {% if stats.get('reading_eras') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Reading Eras</h3>
            <canvas id="chart-eras" height="200"></canvas>
        </div>
        {% endif %}

        {% if stats.get('attention_span') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Attention Span</h3>
            <canvas id="chart-pages" height="200"></canvas>
        </div>
        {% endif %}

        {% if stats.get('reading_pace') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Reading Pace</h3>
            <canvas id="chart-pace" height="200"></canvas>
        </div>
        {% endif %}

        {% if stats.get('author_loyalty') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Author Loyalty</h3>
            <canvas id="chart-authors" height="200"></canvas>
        </div>
        {% endif %}

        {% if stats.get('hater_hype') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Hater vs Hype ({{ stats.hater_hype.label }})</h3>
            <canvas id="chart-hater" height="200"></canvas>
        </div>
        {% endif %}

        {% if stats.get('reading_heatmap') %}
        <div class="bg-white rounded-lg shadow-sm border border-stone-200 p-5">
            <h3 class="font-semibold mb-3">Reading Heatmap</h3>
            <div id="heatmap-container" class="overflow-x-auto"></div>
        </div>
        {% endif %}
    </div>
</div>

<!-- AI Analysis Tabs -->
{% if ai.get('psychological') %}
<div class="tab-panel hidden" id="panel-psychological">
    <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-8 prose max-w-none">
        <h2 class="text-2xl font-bold mb-4">Psychological Profile</h2>
        {% if ai.psychological.archetype %}
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
            <p class="font-semibold text-amber-900">Archetype: {{ ai.psychological.archetype }}</p>
        </div>
        {% endif %}
        {% if ai.psychological['values'] %}
        <h3>Core Values</h3>
        <ul>{% for v in ai.psychological['values'] %}<li>{{ v }}</li>{% endfor %}</ul>
        {% endif %}
        {% if ai.psychological.traits %}
        <h3>Personality Traits</h3>
        <ul>{% for t in ai.psychological.traits %}<li>{{ t }}</li>{% endfor %}</ul>
        {% endif %}
        {% if ai.psychological.searching_for %}
        <h3>What They're Searching For</h3>
        <p>{{ ai.psychological.searching_for }}</p>
        {% endif %}
        {% if ai.psychological.summary %}
        <h3>Summary</h3>
        <p>{{ ai.psychological.summary }}</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if ai.get('roast') %}
<div class="tab-panel hidden" id="panel-roast">
    <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-8 prose max-w-none">
        <h2 class="text-2xl font-bold mb-4">Roast My Shelf</h2>
        {% if ai.roast.roast %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 text-lg">
            <p>{{ ai.roast.roast }}</p>
        </div>
        {% endif %}
        {% if ai.roast.guilty_pleasures %}
        <h3>Guilty Pleasures</h3>
        <ul>{% for g in ai.roast.guilty_pleasures %}<li>{{ g }}</li>{% endfor %}</ul>
        {% endif %}
        {% if ai.roast.stereotype %}
        <h3>Reader Stereotype</h3>
        <p>{{ ai.roast.stereotype }}</p>
        {% endif %}
        {% if ai.roast.one_liner %}
        <div class="bg-stone-100 rounded-lg p-4 mt-6 text-center italic text-lg">
            "{{ ai.roast.one_liner }}"
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if ai.get('vibe_check') %}
<div class="tab-panel hidden" id="panel-vibe_check">
    <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-8 prose max-w-none">
        <h2 class="text-2xl font-bold mb-4">Vibe Check</h2>
        {% if ai.vibe_check.primary_aesthetic %}
        <div class="bg-violet-50 border border-violet-200 rounded-lg p-4 mb-6">
            <p class="font-semibold text-violet-900">Primary Aesthetic: {{ ai.vibe_check.primary_aesthetic }}</p>
            {% if ai.vibe_check.secondary_aesthetic %}
            <p class="text-violet-700">Secondary: {{ ai.vibe_check.secondary_aesthetic }}</p>
            {% endif %}
        </div>
        {% endif %}
        {% if ai.vibe_check.playlist_vibe %}
        <h3>Playlist Vibe</h3>
        <p>{{ ai.vibe_check.playlist_vibe }}</p>
        {% endif %}
        {% if ai.vibe_check.bookshelf_as_place %}
        <h3>If Your Bookshelf Were a Place</h3>
        <p>{{ ai.vibe_check.bookshelf_as_place }}</p>
        {% endif %}
        {% if ai.vibe_check.summary %}
        <p class="mt-4">{{ ai.vibe_check.summary }}</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if ai.get('red_green_flags') %}
<div class="tab-panel hidden" id="panel-flags">
    <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-8 prose max-w-none">
        <h2 class="text-2xl font-bold mb-4">Red & Green Flags</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if ai.red_green_flags.green_flags %}
            <div>
                <h3 class="text-green-700">Green Flags</h3>
                {% for flag in ai.red_green_flags.green_flags %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                    <p class="font-semibold text-green-800">{{ flag.flag }}</p>
                    <p class="text-green-700 text-sm">{{ flag.evidence }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% if ai.red_green_flags.red_flags %}
            <div>
                <h3 class="text-red-700">Red Flags</h3>
                {% for flag in ai.red_green_flags.red_flags %}
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                    <p class="font-semibold text-red-800">{{ flag.flag }}</p>
                    <p class="text-red-700 text-sm">{{ flag.evidence }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if ai.get('blind_spots') %}
<div class="tab-panel hidden" id="panel-blind_spots">
    <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-8 prose max-w-none">
        <h2 class="text-2xl font-bold mb-4">Blind Spots</h2>
        {% if ai.blind_spots.gaps %}
        {% for gap in ai.blind_spots.gaps %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="text-blue-900 mt-0">{{ gap.area }}</h3>
            <p class="text-blue-800">{{ gap.description }}</p>
            {% if gap.recommendations %}
            <p class="font-semibold text-blue-900 text-sm mt-2">Try reading:</p>
            <ul class="text-blue-700 text-sm">
                {% for rec in gap.recommendations %}<li>{{ rec }}</li>{% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>
{% endif %}

{% if ai.get('reading_evolution') %}
<div class="tab-panel hidden" id="panel-evolution">
    <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-8 prose max-w-none">
        <h2 class="text-2xl font-bold mb-4">Reading Evolution</h2>
        {% if ai.reading_evolution.eras %}
        {% for era in ai.reading_evolution.eras %}
        <div class="border-l-4 border-stone-300 pl-4 mb-6">
            <h3 class="mt-0">{{ era.name }}</h3>
            <p class="text-stone-500 text-sm">{{ era.period }}</p>
            <p>{{ era.description }}</p>
        </div>
        {% endfor %}
        {% endif %}
        {% if ai.reading_evolution.trajectory %}
        <h3>Overall Trajectory</h3>
        <p>{{ ai.reading_evolution.trajectory }}</p>
        {% endif %}
        {% if ai.reading_evolution.prediction %}
        <div class="bg-stone-100 rounded-lg p-4 mt-4">
            <h3 class="mt-0">What's Next?</h3>
            <p>{{ ai.reading_evolution.prediction }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if ai.get('recommendations') %}
<div class="tab-panel hidden" id="panel-recommendations">
    <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-8 prose max-w-none">
        <h2 class="text-2xl font-bold mb-4">Book Recommendations</h2>

        {% if ai.recommendations.top_10 %}
        <h3>Top 10 Picks For You</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 not-prose">
            {% for rec in ai.recommendations.top_10 %}
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <p class="font-semibold text-amber-900">{{ rec.title }}</p>
                <p class="text-amber-700 text-sm">by {{ rec.author }}</p>
                <p class="text-amber-800 text-sm mt-2">{{ rec.reason }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if ai.recommendations.deep_cuts %}
        <h3 class="mt-8">Deep Cuts</h3>
        <p class="text-stone-500 text-sm">Lesser-known gems you'd love</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 not-prose">
            {% for rec in ai.recommendations.deep_cuts %}
            <div class="bg-violet-50 border border-violet-200 rounded-lg p-4">
                <p class="font-semibold text-violet-900">{{ rec.title }}</p>
                <p class="text-violet-700 text-sm">by {{ rec.author }}</p>
                <p class="text-violet-800 text-sm mt-2">{{ rec.reason }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if ai.recommendations.next_favorite_author %}
        <h3 class="mt-8">Your Next Favorite Author</h3>
        <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 not-prose">
            <p class="font-semibold text-emerald-900 text-lg">{{ ai.recommendations.next_favorite_author.name }}</p>
            <p class="text-emerald-800 mt-1">{{ ai.recommendations.next_favorite_author.why }}</p>
            <p class="text-emerald-700 text-sm mt-2">Start with: <strong>{{ ai.recommendations.next_favorite_author.start_with }}</strong></p>
        </div>
        {% endif %}

        {% if ai.recommendations.wildcard %}
        <h3 class="mt-8">Wildcard Pick</h3>
        <div class="bg-rose-50 border border-rose-200 rounded-lg p-4 not-prose">
            <p class="font-semibold text-rose-900">{{ ai.recommendations.wildcard.title }}</p>
            <p class="text-rose-700 text-sm">by {{ ai.recommendations.wildcard.author }}</p>
            <p class="text-rose-800 text-sm mt-2">{{ ai.recommendations.wildcard.reason }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'border-stone-800', 'text-stone-800');
                b.classList.add('border-transparent', 'text-stone-500');
            });
            btn.classList.add('active', 'border-stone-800', 'text-stone-800');
            btn.classList.remove('border-transparent', 'text-stone-500');

            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            const tabName = btn.dataset.tab;
            const panelId = tabName === 'flags' ? 'panel-flags' : 'panel-' + tabName;
            document.getElementById(panelId).classList.remove('hidden');
        });
    });

    // Render charts
    const statsData = {{ stats_json | safe }};
    if (statsData) renderAllCharts(statsData);
</script>
{% endblock %}
